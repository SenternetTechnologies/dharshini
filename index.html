<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dharshini - Chat & Connect</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #6366f1;
            --secondary: #a855f7;
            --bg: #0f172a;
        }
        body {
            background-color: var(--bg);
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh;
            overflow: hidden;
        }
        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .tab-content { display: none; }
        .tab-content.active { display: flex; flex-direction: column; height: 100%; }
        .verified-badge { color: #3b82f6; margin-left: 4px; }
        .message-bubble { max-width: 80%; border-radius: 18px; padding: 10px 16px; margin-bottom: 8px; position: relative; }
        .sent { background: var(--primary); align-self: flex-end; border-bottom-right-radius: 4px; }
        .received { background: #334155; align-self: flex-start; border-bottom-left-radius: 4px; }
        .bottom-nav { border-top: 1px solid rgba(255, 255, 255, 0.1); }
        #notification-toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 100; display: none;
        }
    </style>
</head>
<body>

    <!-- Notification Toast -->
    <div id="notification-toast" class="glass px-6 py-3 rounded-full text-sm font-medium shadow-2xl border-indigo-500 border">
        <span id="toast-msg">New Message!</span>
    </div>

    <!-- Auth Screen -->
    <div id="auth-screen" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-950">
        <div class="glass w-full max-w-md p-8 rounded-3xl shadow-2xl text-center">
            <h1 class="text-4xl font-bold mb-2 bg-gradient-to-r from-indigo-400 to-purple-400 bg-clip-text text-transparent">Dharshini</h1>
            <p class="text-slate-400 mb-8">Ulla varuvatharku login seiyavum</p>
            
            <div class="space-y-4 text-left">
                <div>
                    <label class="block text-sm font-medium mb-1">Username</label>
                    <input type="text" id="auth-username" class="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Username nuliya...">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Password</label>
                    <input type="password" id="auth-password" class="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Password nuliya...">
                </div>
                <button onclick="handleAuth()" id="auth-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 transition-colors py-3 rounded-xl font-bold mt-4 shadow-lg flex items-center justify-center">
                    <span id="auth-text">Login / Sign Up</span>
                </button>
            </div>
            <p class="mt-6 text-xs text-slate-500">Admin username: dharshini | Trichy</p>
        </div>
    </div>

    <!-- Main App UI (Hidden initially) -->
    <div id="app-container" class="hidden flex flex-col h-full max-w-2xl mx-auto border-x border-slate-800">
        
        <!-- Top Bar -->
        <header class="p-4 glass flex justify-between items-center z-10">
            <div class="flex items-center gap-2">
                <span class="font-bold text-xl tracking-tight text-indigo-400">Dharshini</span>
            </div>
            <div class="flex items-center gap-4">
                <button id="admin-dash-btn" onclick="showTab('admin')" class="hidden bg-red-500/20 text-red-400 text-xs px-3 py-1 rounded-full border border-red-500/50">Admin Dash</button>
                <button onclick="logout()" class="text-slate-400 hover:text-white"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </header>

        <!-- Search Bar (Global only) -->
        <div id="search-section" class="px-4 py-2 glass border-t border-slate-800 hidden">
            <div class="relative">
                <i class="fas fa-search absolute left-3 top-3 text-slate-500"></i>
                <input type="text" id="user-search" oninput="searchUsers()" placeholder="Username theduga..." class="w-full bg-slate-900 rounded-full pl-10 pr-4 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500">
            </div>
        </div>

        <!-- Content Area -->
        <main class="flex-1 overflow-y-auto relative">
            
            <!-- Inbox Tab -->
            <div id="tab-inbox" class="tab-content active p-4 space-y-4">
                <h2 class="text-lg font-bold mb-2">Ungal Inbox</h2>
                <div id="chat-list" class="space-y-3">
                    <div class="text-center text-slate-500 mt-10">Loading chats...</div>
                </div>
            </div>

            <!-- Global Chat Tab -->
            <div id="tab-global" class="tab-content p-4 flex flex-col h-full">
                <div id="global-messages" class="flex-1 overflow-y-auto space-y-3 pr-2 mb-4 flex flex-col"></div>
                <div class="flex items-center gap-2 p-2 glass rounded-2xl">
                    <button onclick="triggerFile('global')" class="text-slate-400 p-2"><i class="fas fa-paperclip"></i></button>
                    <input type="text" id="global-input" placeholder="Yellarkum message pannu..." class="flex-1 bg-transparent border-none focus:outline-none text-sm px-2">
                    <button onclick="sendGlobalMessage()" class="bg-indigo-600 w-10 h-10 rounded-xl flex items-center justify-center"><i class="fas fa-paper-plane text-sm"></i></button>
                </div>
            </div>

            <!-- Profile / Explore Tab -->
            <div id="tab-profile" class="tab-content p-4 overflow-y-auto">
                <div id="profile-view" class="space-y-6"></div>
                <div id="user-list-results" class="mt-8 space-y-4"></div>
            </div>

            <!-- Private Chat Window (Modal Overlay) -->
            <div id="private-chat" class="hidden absolute inset-0 bg-slate-950 z-20 flex flex-col">
                <div class="p-4 glass flex items-center gap-4">
                    <button onclick="closePrivateChat()" class="text-slate-400"><i class="fas fa-arrow-left"></i></button>
                    <div class="flex items-center gap-3">
                        <div id="pc-avatar" class="w-10 h-10 rounded-full bg-indigo-500 flex items-center justify-center font-bold">U</div>
                        <div>
                            <div class="flex items-center">
                                <span id="pc-name" class="font-bold">Username</span>
                                <span id="pc-verified" class="hidden verified-badge"><i class="fas fa-check-circle text-[10px]"></i></span>
                            </div>
                            <span id="pc-status" class="text-[10px] text-slate-500">Active</span>
                        </div>
                    </div>
                </div>
                <div id="pc-messages" class="flex-1 overflow-y-auto p-4 flex flex-col space-y-3"></div>
                <div class="p-4 bg-slate-900">
                    <div class="flex items-center gap-2 p-2 bg-slate-800 rounded-2xl">
                        <button onclick="triggerFile('private')" class="text-slate-400 p-2"><i class="fas fa-paperclip"></i></button>
                        <input type="text" id="pc-input" placeholder="Message seiya..." class="flex-1 bg-transparent border-none focus:outline-none text-sm px-2">
                        <button onclick="sendPrivateMessage()" class="bg-indigo-600 w-10 h-10 rounded-xl flex items-center justify-center"><i class="fas fa-paper-plane text-sm"></i></button>
                    </div>
                </div>
            </div>

            <!-- Admin Dashboard -->
            <div id="tab-admin" class="tab-content p-4">
                <h2 class="text-2xl font-bold mb-4">Admin Dashboard</h2>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="glass p-4 rounded-2xl">
                        <div class="text-xs text-slate-400">Total Users</div>
                        <div id="count-users" class="text-2xl font-bold">0</div>
                    </div>
                    <div class="glass p-4 rounded-2xl">
                        <div class="text-xs text-slate-400">System Status</div>
                        <div class="text-green-400 font-bold">Online</div>
                    </div>
                </div>
                <h3 class="font-bold mb-2">User Database</h3>
                <div id="admin-user-list" class="space-y-3"></div>
            </div>

        </main>

        <!-- Hidden File Input -->
        <input type="file" id="file-input" class="hidden" onchange="handleFile(event)">

        <!-- Bottom Navigation -->
        <nav class="bottom-nav h-16 glass grid grid-cols-3">
            <button onclick="showTab('inbox')" class="nav-item flex flex-col items-center justify-center text-slate-400 transition-colors" data-tab="inbox">
                <i class="fas fa-comment-dots text-xl"></i>
                <span class="text-[10px] mt-1">Inbox</span>
            </button>
            <button onclick="showTab('global')" class="nav-item flex flex-col items-center justify-center text-slate-400 transition-colors" data-tab="global">
                <i class="fas fa-globe-americas text-xl"></i>
                <span class="text-[10px] mt-1">Global</span>
            </button>
            <button onclick="showTab('profile')" class="nav-item flex flex-col items-center justify-center text-slate-400 transition-colors" data-tab="profile">
                <i class="fas fa-user-circle text-xl"></i>
                <span class="text-[10px] mt-1">Profile</span>
            </button>
        </nav>
    </div>

    <!-- Firebase Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, onSnapshot, addDoc, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBcJNL7NSXLlpvtvvU_EvtA2xh-v7xU33w",
            authDomain: "josen-240c7.firebaseapp.com",
            databaseURL: "https://josen-240c7-default-rtdb.firebaseio.com",
            projectId: "josen-240c7",
            storageBucket: "josen-240c7.firebasestorage.app",
            messagingSenderId: "1007530396134",
            appId: "1:1007530396134:web:bc2bda6a0b147c2944ae27"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'dharshini-chat-v2';

        // State
        let userData = null;
        let users = {};
        let activePrivateChatId = null;
        let fileMode = 'global';

        const ADMIN_USER = "dharshini";
        const ADMIN_PASS = "dharshini.com";

        // Global Listeners Initializer
        const startListeners = (username) => {
            const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', username);
            
            // 1. Current User Sync
            onSnapshot(userRef, (snap) => {
                if(snap.exists()) {
                    userData = snap.data();
                    if (userData.isAdmin) {
                        document.getElementById('admin-dash-btn').classList.remove('hidden');
                    }
                    if (document.getElementById('tab-profile').classList.contains('active')) {
                        renderMyProfile();
                    }
                }
            }, (err) => console.error("User snap error", err));

            // 2. All Users Sync
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'users'), (snap) => {
                const userList = {};
                snap.forEach(doc => { userList[doc.id] = doc.data(); });
                users = userList;
                renderInbox();
                renderAdminUsers();
                updateCounts();
            }, (err) => console.error("Collection snap error", err));

            // 3. Global Chat
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'global_messages'), (snap) => {
                const msgs = snap.docs.map(d => ({id: d.id, ...d.data()})).sort((a, b) => (a.timestamp?.toMillis?.() || 0) - (b.timestamp?.toMillis?.() || 0));
                renderGlobalMessages(msgs);
            }, (err) => console.error("Global chat error", err));

            // Presence Pulse
            setInterval(() => {
                if (userData) {
                    updateDoc(userRef, { lastSeen: Date.now() }).catch(() => {});
                }
            }, 20000);
        };

        // Auth Logic
        window.handleAuth = async () => {
            const username = document.getElementById('auth-username').value.trim().toLowerCase();
            const password = document.getElementById('auth-password').value;
            const authBtn = document.getElementById('auth-btn');
            const authText = document.getElementById('auth-text');

            if (!username || !password) return alert("Username & Password nuliya vendum");

            authBtn.disabled = true;
            authText.innerText = "Connecting...";

            try {
                // Wait for Firebase Auth
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', username);
                const userSnap = await getDoc(userRef);

                if (userSnap.exists()) {
                    if (userSnap.data().password !== password) {
                        authBtn.disabled = false;
                        authText.innerText = "Login / Sign Up";
                        return alert("Thavarana password!");
                    }
                } else {
                    // Sign up
                    const isSystemAdmin = (username === ADMIN_USER && password === ADMIN_PASS);
                    await setDoc(userRef, {
                        username: username,
                        password: password,
                        displayName: username,
                        verified: isSystemAdmin,
                        followers: [],
                        following: [],
                        lastSeen: Date.now(),
                        isAdmin: isSystemAdmin
                    });
                }

                localStorage.setItem('dharshini_user', username);
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                startListeners(username);

            } catch (error) {
                console.error("Auth Error:", error);
                alert("Login failed: " + error.message);
                authBtn.disabled = false;
                authText.innerText = "Login / Sign Up";
            }
        };

        // Navigation
        window.showTab = (tabName) => {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('text-indigo-400'));
            
            document.getElementById(`tab-${tabName}`).classList.add('active');
            const navBtn = document.querySelector(`.nav-item[data-tab="${tabName}"]`);
            if (navBtn) navBtn.classList.add('text-indigo-400');

            document.getElementById('search-section').classList.toggle('hidden', (tabName === 'inbox' || tabName === 'admin'));

            if (tabName === 'profile') renderMyProfile();
        };

        // Renderers
        const renderGlobalMessages = (msgs) => {
            const container = document.getElementById('global-messages');
            if(!container) return;
            const atBottom = container.scrollHeight - container.scrollTop <= container.clientHeight + 100;
            
            container.innerHTML = msgs.map(m => {
                const isMe = m.sender === userData?.username;
                const senderData = users[m.sender] || { displayName: m.sender };
                const timeStr = m.timestamp ? new Date(m.timestamp.toMillis()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '...';
                
                return `
                    <div class="message-bubble ${isMe ? 'sent' : 'received'}">
                        ${!isMe ? `<div class="text-[10px] font-bold text-indigo-300 mb-1">${senderData.displayName} ${senderData.verified ? '<i class="fas fa-check-circle"></i>' : ''}</div>` : ''}
                        <div class="text-sm">${m.text || ''}</div>
                        ${m.fileUrl && m.fileUrl !== "#" ? `<div class="mt-2"><a href="${m.fileUrl}" target="_blank" class="text-xs underline flex items-center gap-1"><i class="fas fa-file"></i> File</a></div>` : ''}
                        <div class="text-[8px] opacity-50 text-right mt-1">${timeStr}</div>
                    </div>
                `;
            }).join('');

            if (atBottom) container.scrollTop = container.scrollHeight;
        };

        const renderInbox = () => {
            const container = document.getElementById('chat-list');
            if(!userData) return;

            const inboxUsers = Object.keys(users).filter(id => id !== userData.username);
            
            // Show Admin always, plus people you follow
            const filtered = inboxUsers.filter(uid => {
                const u = users[uid];
                return u.isAdmin || userData.following.includes(uid);
            });

            if (filtered.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-500 mt-10">Inbox kaaliyakullathu. Search-il yaraiyavathu theduga.</div>';
                return;
            }

            container.innerHTML = filtered.map(uid => {
                const u = users[uid];
                const isOnline = (Date.now() - (u.lastSeen || 0)) < 60000;
                return `
                    <div onclick="openPrivateChat('${uid}')" class="flex items-center gap-4 p-3 glass rounded-2xl cursor-pointer hover:bg-white/10 transition-colors">
                        <div class="relative">
                            <div class="w-12 h-12 rounded-full bg-slate-700 flex items-center justify-center font-bold text-lg">${u.displayName[0].toUpperCase()}</div>
                            ${isOnline ? '<div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-slate-900 rounded-full"></div>' : ''}
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center font-bold">
                                ${u.displayName}
                                ${u.verified ? '<i class="fas fa-check-circle verified-badge"></i>' : ''}
                            </div>
                            <div class="text-xs text-slate-500">${isOnline ? 'Online' : 'Active lately'}</div>
                        </div>
                        <i class="fas fa-chevron-right text-slate-600"></i>
                    </div>
                `;
            }).join('');
        };

        window.viewUserProfile = (uid) => {
            const u = users[uid];
            if (!u) return;
            const container = document.getElementById('profile-view');
            const isMe = uid === userData?.username;
            const isFollowing = userData?.following?.includes(uid);

            container.innerHTML = `
                <div class="text-center p-4">
                    <div class="w-24 h-24 mx-auto rounded-full bg-indigo-600 flex items-center justify-center text-4xl font-bold mb-4 shadow-xl">
                        ${u.displayName[0].toUpperCase()}
                    </div>
                    <h2 class="text-2xl font-bold flex justify-center items-center gap-2">
                        ${u.displayName}
                        ${u.verified ? '<i class="fas fa-check-circle verified-badge"></i>' : ''}
                    </h2>
                    <p class="text-slate-500 text-sm">@${u.username}</p>
                    
                    <div class="flex justify-center gap-8 my-6">
                        <div class="text-center">
                            <div class="font-bold">${u.followers?.length || 0}</div>
                            <div class="text-xs text-slate-500">Followers</div>
                        </div>
                        <div class="text-center">
                            <div class="font-bold">${u.following?.length || 0}</div>
                            <div class="text-xs text-slate-500">Following</div>
                        </div>
                    </div>

                    <div class="flex gap-2">
                        ${!isMe ? `
                            <button onclick="toggleFollow('${uid}')" class="flex-1 ${isFollowing ? 'bg-slate-700' : 'bg-indigo-600'} py-3 rounded-xl font-bold transition-all">
                                ${isFollowing ? 'Unfollow' : 'Follow'}
                            </button>
                            <button onclick="openPrivateChat('${uid}')" class="flex-1 bg-white/10 hover:bg-white/20 py-3 rounded-xl font-bold">
                                Message
                            </button>
                        ` : `
                            <button onclick="editProfilePrompt()" class="w-full bg-white/10 py-3 rounded-xl font-bold">Edit Profile</button>
                        `}
                    </div>
                </div>
            `;
            document.getElementById('user-list-results').innerHTML = '';
        };

        const renderMyProfile = () => {
            if(userData) viewUserProfile(userData.username);
        };

        // Message Handlers
        window.sendGlobalMessage = async () => {
            const input = document.getElementById('global-input');
            const text = input.value.trim();
            if (!text) return;
            input.value = '';
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'global_messages'), {
                sender: userData.username,
                text: text,
                timestamp: serverTimestamp()
            });
        };

        window.openPrivateChat = (uid) => {
            const u = users[uid];
            if(!u) return;
            document.getElementById('pc-name').innerText = u.displayName;
            document.getElementById('pc-avatar').innerText = u.displayName[0].toUpperCase();
            document.getElementById('pc-verified').classList.toggle('hidden', !u.verified);
            
            const pcWindow = document.getElementById('private-chat');
            pcWindow.classList.remove('hidden');

            const ids = [userData.username, uid].sort();
            activePrivateChatId = ids.join('_');

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', `chat_${activePrivateChatId}`), (snap) => {
                const msgs = snap.docs.map(d => d.data()).sort((a,b) => (a.timestamp?.toMillis?.() || 0) - (b.timestamp?.toMillis?.() || 0));
                const container = document.getElementById('pc-messages');
                container.innerHTML = msgs.map(m => {
                    const isMe = m.sender === userData.username;
                    return `
                        <div class="message-bubble ${isMe ? 'sent' : 'received'}">
                            <div class="text-sm">${m.text || ''}</div>
                            <div class="text-[8px] opacity-50 text-right mt-1">${m.timestamp ? new Date(m.timestamp.toMillis()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '...'}</div>
                        </div>
                    `;
                }).join('');
                container.scrollTop = container.scrollHeight;
            });
        };

        window.sendPrivateMessage = async () => {
            const input = document.getElementById('pc-input');
            const text = input.value.trim();
            if (!text || !activePrivateChatId) return;
            input.value = '';
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', `chat_${activePrivateChatId}`), {
                sender: userData.username,
                text: text,
                timestamp: serverTimestamp()
            });
        };

        window.closePrivateChat = () => {
            document.getElementById('private-chat').classList.add('hidden');
        };

        // Social
        window.toggleFollow = async (uid) => {
            const myRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', userData.username);
            const targetRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', uid);
            
            let myFollowing = [...(userData.following || [])];
            let theirFollowers = [...(users[uid].followers || [])];

            if (myFollowing.includes(uid)) {
                myFollowing = myFollowing.filter(x => x !== uid);
                theirFollowers = theirFollowers.filter(x => x !== userData.username);
            } else {
                myFollowing.push(uid);
                theirFollowers.push(userData.username);
            }

            await updateDoc(myRef, { following: myFollowing });
            await updateDoc(targetRef, { followers: theirFollowers });
        };

        window.searchUsers = () => {
            const queryText = document.getElementById('user-search').value.toLowerCase();
            const resultsContainer = document.getElementById('user-list-results');
            if (!queryText) { resultsContainer.innerHTML = ''; return; }

            const found = Object.keys(users).filter(uid => uid.includes(queryText) || users[uid].displayName.toLowerCase().includes(queryText));
            resultsContainer.innerHTML = `<h3 class="text-xs font-bold text-slate-500 uppercase px-2 mb-2">Results</h3>` + found.map(uid => {
                const u = users[uid];
                return `
                    <div onclick="viewUserProfile('${uid}')" class="flex items-center gap-3 p-3 glass rounded-xl cursor-pointer mx-2">
                        <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center font-bold">${u.displayName[0].toUpperCase()}</div>
                        <div>
                            <div class="font-bold flex items-center">${u.displayName} ${u.verified ? '<i class="fas fa-check-circle verified-badge"></i>' : ''}</div>
                            <div class="text-xs text-slate-500">@${u.username}</div>
                        </div>
                    </div>
                `;
            }).join('');
        };

        // Admin
        const renderAdminUsers = () => {
            if (!userData?.isAdmin) return;
            const container = document.getElementById('admin-user-list');
            container.innerHTML = Object.keys(users).map(uid => {
                const u = users[uid];
                return `
                    <div class="p-3 glass rounded-xl flex items-center justify-between">
                        <div>
                            <div class="font-bold text-sm">${u.displayName} (@${u.username})</div>
                            <div class="text-[10px] text-slate-500">Verified: ${u.verified} | Admin: ${u.isAdmin}</div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="toggleVerify('${uid}')" class="bg-blue-600/30 text-blue-400 border border-blue-500/50 text-[10px] px-2 py-1 rounded">Verify</button>
                            <button onclick="deleteUserPrompt('${uid}')" class="bg-red-600/30 text-red-400 border border-red-500/50 text-[10px] px-2 py-1 rounded">Del</button>
                        </div>
                    </div>
                `;
            }).join('');
        };

        window.toggleVerify = async (uid) => {
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', uid), {
                verified: !users[uid].verified
            });
        };

        window.deleteUserPrompt = async (uid) => {
            if (uid === ADMIN_USER) return alert("Admin-ai delete seiya mudiyathu!");
            if (confirm(`User ${uid}-ai permanent-aga delete seiyava?`)) {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', uid));
            }
        };

        const updateCounts = () => {
            const count = Object.keys(users).length;
            const el = document.getElementById('count-users');
            if(el) el.innerText = count;
        };

        window.logout = () => {
            localStorage.removeItem('dharshini_user');
            location.reload();
        };

        // Auto-login logic
        onAuthStateChanged(auth, (user) => {
            const savedUser = localStorage.getItem('dharshini_user');
            if (user && savedUser) {
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                startListeners(savedUser);
            }
        });

    </script>
</body>
</html>

